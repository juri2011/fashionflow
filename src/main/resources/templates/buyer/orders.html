<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <title>구매내역</title>
    <style>
        /* 각 박스의 스타일 */
        .purchase-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        /* 상품 이미지 스타일 */
        .product-image {
            max-width: 100px;
            max-height: 100px;
        }

        /* 리뷰 남기기 버튼 스타일 */
        .review-button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* 리뷰 입력 텍스트 박스 스타일 */
        .review-textbox {
            display: none;
            margin-top: 10px;
        }

        /* 점수 선택 바 너비 조정 */
        .score-range {
            width: 50%;
            margin: 0 auto;
        }

    </style>
</head>
<body>

<div layout:fragment="content">

    <h1>구매내역</h1>
    <hr>

    <h2>구매완료</h2>

    <!-- 구매내역 목록 -->
    <div th:each="purchase : ${getItemBuyListWithImg}" class="purchase-box">
        <form th:action="@{/buyer/reviews}" method="post" class="purchase-form">


            <input type="hidden" name="id" th:value="${purchase.id}" />
            <img th:if="${purchase.imgName}" th:src="'/images/'+${purchase.imgName}" alt="Product Image" class="product-image">
            <span th:if="${purchase.itemName}" th:text="'상품명: ' + ${purchase.itemName}" ></span>
            <span th:if="${purchase.price}" th:text="'가격: ' + ${purchase.price}" ></span>
            <span th:if="${purchase.buyDate}" th:text="'거래일: ' + ${#temporals.format(purchase.buyDate, 'yyyy-MM-dd')}" ></span>


            <div th:unless="${purchase.reviewExists}">
                <button type="button" class="review-button">리뷰 남기기</button>

                <!-- 리뷰 입력 텍스트 박스 -->
                <textarea class="review-textbox" name="content" placeholder="리뷰를 작성해주세요"></textarea>
                <!-- 리뷰 입력 텍스트 박스 아래에 추가 -->
                <label for="scoreRange" class="form-label" style="display: none;">점수 선택:</label>
                <input type="range" class="form-range score-range" id="scoreRange" name="score" min="1" max="100" value="50" style="display: none;">
                <span id="scoreValue" style="display: none;">50 점</span> <!-- 점수 표시 -->
                <button type="submit" class="submit-review" style="display: none;">제출</button>

                <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            </div>
            <div th:if="${purchase.reviewExists}">
                <p>리뷰 완료</p>
            </div>
        </form>
    </div>

</div>
</body>
</html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    document.querySelectorAll('.review-button').forEach(function(button) {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // 기본 이벤트 막기

            var form = this.closest('.purchase-form');
            var reviewTextbox = form.querySelector('.review-textbox');
            var scoreRange = form.querySelector('.score-range');
            var scoreLabel = form.querySelector('.form-label');
            var scoreValue = form.querySelector('#scoreValue'); // 점수 표시
            var submitButton = form.querySelector('.submit-review');

            // 표시/숨김 토글
            if (reviewTextbox.style.display === 'none') {
                reviewTextbox.style.display = 'block';
                scoreRange.style.display = 'block';
                scoreLabel.style.display = 'block';
                scoreValue.style.display = 'block';
                submitButton.style.display = 'block';
            } else {
                reviewTextbox.style.display = 'none';
                scoreRange.style.display = 'none';
                scoreLabel.style.display = 'none';
                scoreValue.style.display = 'none';
                submitButton.style.display = 'none';
            }

            // 점수 표시 업데이트
            scoreRange.oninput = function() {
                scoreValue.textContent = this.value + " 점";
            };
        });
    });

    document.querySelectorAll('.submit-review').forEach(function(submitButton) {
        submitButton.addEventListener('click', function(event) {
            var form = this.closest('.purchase-form');
            var scoreRange = form.querySelector('.score-range');
            var selectedScore = scoreRange.value;

            if (selectedScore === "") {
                alert("점수를 선택하세요.");
                event.preventDefault(); // 제출 중지
            }
        });
    });

</script>
