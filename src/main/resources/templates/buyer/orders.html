<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <title>구매내역</title>
    <style>
        /* 각 박스의 스타일 */
        .purchase-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        /* 상품 이미지 스타일 */
        .product-image {
            max-width: 100px;
            max-height: 100px;
        }

        /* 리뷰 남기기 버튼 스타일 */
        .review-button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* 리뷰 입력 텍스트 박스 스타일 */
    .review-textbox {
        display: none;
        margin-top: 10px;
    }
    </style>
</head>
<body>

<div layout:fragment="content">

    <h1>구매내역</h1>
    <hr>

    <h2>구매완료</h2>

    <!-- 구매내역 목록 -->
    <div th:each="purchase : ${getItemBuyListWithImg}" class="purchase-box">
        <form th:action="@{/buyer/reviews}" method="post" class="purchase-form">


            <input type="hidden" name="id" th:value="${purchase.id}" />
            <img th:if="${purchase.imgName != null}" th:src="@{'/images/' + ${purchase.imgName}}" alt="Product Image" class="product-image">
            <img th:unless="${purchase.imgName != null}" src="/img/default.PNG" alt="대체 이미지" class="product-image">





            <span th:if="${purchase.itemName}" th:text="'상품명: ' + ${purchase.itemName}" ></span>
            <span th:if="${purchase.price}" th:text="'가격: ' + ${purchase.price}" ></span>
            <span th:if="${purchase.buyDate}" th:text="'거래일: ' + ${#temporals.format(purchase.buyDate, 'yyyy-MM-dd')}" ></span>


            <div th:unless="${purchase.reviewExists}">
                <button type="button" class="review-button">리뷰 남기기</button>

                <!-- 리뷰 입력 텍스트 박스 -->
                <textarea class="review-textbox" name="content" placeholder="리뷰를 작성해주세요"></textarea>
                <!-- 점수 선택 드롭다운 -->
                <select class="score-dropdown" name="score" style="display: none;">
                    <option value="">점수를 선택하세요</option>
                    <option th:each="num : ${#numbers.sequence(1,100)}" th:value="${num}" th:text="${num}" name="score"></option>
                </select>

                <button type="submit" class="submit-review" style="display: none;">제출</button>

                <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
            </div>
            <div th:if="${purchase.reviewExists}">
                <p>리뷰 완료</p>
            </div>
        </form>
    </div>

</div>
</body>
</html>

<script>
    document.querySelectorAll('.review-button').forEach(function(button) {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // 기본 이벤트 막기

            var form = this.closest('.purchase-form');
            var reviewTextbox = form.querySelector('.review-textbox');
            var scoreDropdown = form.querySelector('.score-dropdown');
            var submitButton = form.querySelector('.submit-review');

            // 리뷰 입력 텍스트 박스와 점수 선택 드롭다운을 표시/숨김
            if (reviewTextbox.style.display === 'none') {
                reviewTextbox.style.display = 'block';
                scoreDropdown.style.display = 'block';
                submitButton.style.display = 'block';
            } else {
                reviewTextbox.style.display = 'none';
                scoreDropdown.style.display = 'none';
                submitButton.style.display = 'none';
            }
        });
    });

    document.querySelectorAll('.submit-review').forEach(function(submitButton) {
        submitButton.addEventListener('click', function(event) {
            var form = this.closest('.purchase-form');
            var scoreDropdown = form.querySelector('.score-dropdown');
            var selectedScore = scoreDropdown.value;

            // 선택된 점수가 없는 경우 경고 표시
            if (selectedScore === "") {
                alert("점수를 선택하세요.");
                event.preventDefault(); // 제출 중지
            }
        });
    });

</script>
